name: Build documentation

on:
    push:
        branches:
            - "for-jetbrains"

permissions:
    id-token: write
    pages: write

env:
    ALGOLIA_APP_NAME: ${{ secrets.ALGOLIA_APPLICATION_ID }}
    ALGOLIA_ARTIFACT: algolia-indexes-LARAVEL-LANG.zip
    ALGOLIA_INDEX_NAME: laravel-lang
    ALGOLIA_KEY: ${{ secrets.ALGOLIA_KEY }}
    ARTIFACT: webHelpLARAVEL-LANG2-all.zip
    CONFIG_JSON_PRODUCT: LARAVEL-LANG
    CONFIG_JSON_VERSION: test
    DOCKER_VERSION: 232.10275
    INSTANCE: docs/laravel-lang

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Build Writerside docs using Docker
                uses: JetBrains/writerside-github-action@v4
                with:
                    instance: ${{ env.INSTANCE }}
                    artifact: ${{ env.ARTIFACT }}
                    docker-version: ${{ env.DOCKER_VERSION }}

            -   name: Upload algolia-indexes
                uses: actions/upload-artifact@v4
                with:
                    name: algolia-indexes
                    path: artifacts/${{ env.ALGOLIA_ARTIFACT }}
                    retention-days: 7
    
    publish-indexes:
        needs: build
        runs-on: ubuntu-latest
        timeout-minutes: 3
        
        container:
            image: registry.jetbrains.team/p/writerside/builder/algolia-publisher:2.0.32-2
        
        steps:
            -   name: Download artifact
                uses: actions/download-artifact@v4
                with:
                    name: algolia-indexes

            -   name: Unzip artifact
                run: |
                    unzip -O UTF-8 -qq ${{ env.ALGOLIA_ARTIFACT }} -d algolia-indexes
                    env "algolia-key=${{env.ALGOLIA_KEY}}" java -jar /opt/builder/help-publication-agent.jar \
                    update-index \
                    --application-name ${{env.ALGOLIA_APP_NAME}} \
                    --index-name ${{env.ALGOLIA_INDEX_NAME}} \
                    --product ${{env.CONFIG_JSON_PRODUCT}} \
                    --version ${{env.CONFIG_JSON_VERSION}} \
                    --index-directory algolia-indexes/ \
                    2>&1 | tee algolia-update-index-log.txt
